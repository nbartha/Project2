# step 2.5 - MODEL EVALUATION


val_loss, val_accuracy = dcnn_model.evaluate(validation_generator)
print(f"\nFinal Validation Accuracy: {val_accuracy:.4f}")
print(f"Final Validation Loss: {val_loss:.4f}")

train_loss = training_history.history['loss'][-1]
train_accuracy = training_history.history['accuracy'][-1]
print(f"Final Training Accuracy: {train_accuracy:.4f}")
print(f"Final Training Loss: {train_loss:.4f}")


# step 2.6 - VISUALIZE TRAINING RESULTS

plt.figure(figsize=(12, 4))
plt.plot(training_history.history['accuracy'], label="Training Accuracy")
plt.plot(training_history.history['val_accuracy'], label="Validation Accuracy")
plt.title("Training and Validation Accuracy")
plt.xlabel("Epoch")
plt.ylabel("Accuracy")
plt.legend()
plt.show()

plt.figure(figsize=(12, 4))
plt.plot(training_history.history['loss'], label="Training Loss")
plt.plot(training_history.history['val_loss'], label="Validation Loss")
plt.title("Training and Validation Loss")
plt.xlabel("Epoch")
plt.ylabel("Loss")
plt.legend()
plt.show()

# Save model for Step 2.7
dcnn_model.save("Aircraft_DCNN_Model.keras")
print("\n Model saved as 'Aircraft_DCNN_Model.keras'")

# step 2.7 - MODEL TESTING


from tensorflow.keras.models import load_model

class ModelTester:
    def __init__(self, model_path, img_width=500, img_height=500):
        self.model = load_model(model_path)
        self.img_width = img_width
        self.img_height = img_height
        self.class_labels = ['Crack', 'Missing Head', 'Paint-Off']

    def preprocess_image(self, image_path):
        img = load_img(image_path, target_size=(self.img_width, self.img_height))
        img_array = img_to_array(img) / 255.0
        img_array = np.expand_dims(img_array, axis=0)
        return img_array

    def make_prediction(self, img_array):
        return self.model.predict(img_array)

    def plot_results(self, image_path, predictions, true_label):
        predicted_label = self.class_labels[np.argmax(predictions)]
        fig, ax = plt.subplots(figsize=(6, 6))
        img = plt.imread(image_path)
        plt.imshow(img)
        ax.axis('off')

        title = f"True Label: {true_label}\nPredicted Label: {predicted_label}"
        plt.title(title)

        sorted_labels = sorted(zip(self.class_labels, predictions[0]), key=lambda x: x[1], reverse=True)
        for i, (label, prob) in enumerate(sorted_labels):
            ax.text(10, 25 + i * 30, f"{label}: {prob * 100:.2f}%", fontsize=10,
                    bbox=dict(facecolor="lightblue", edgecolor="none"))

        plt.figtext(0.5, 0.01, "Nate [501165955]", ha="center", fontsize=12,
                    bbox=dict(facecolor="white", edgecolor="none"))
        plt.tight_layout()
        plt.show()

    def test_image(self, image_path, true_label):
        img_array = self.preprocess_image(image_path)
        predictions = self.make_prediction(img_array)
        self.plot_results(image_path, predictions, true_label)

# TESTING SAMPLE IMAGES

test_images = [
    ("Data/Data/test/crack/test_crack.jpg", "Crack"), # Corrected directory name
    ("Data/Data/test/missing-head/test_missinghead.jpg", "Missing Head"), # Corrected directory name
    ("Data/Data/test/paint-off/test_paintoff.jpg", "Paint-Off") # Corrected directory name
]

tester = ModelTester("Aircraft_DCNN_Model.keras")

for image_path, true_label in test_images:
    tester.test_image(image_path, true_label)
